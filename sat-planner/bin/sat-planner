#!/usr/bin/env ruby

require 'json'
require "fileutils"
require_relative '../lib/utils'
require_relative '../lib/translator'

# Entry point for sat-planner
def main
  bin_name = File.basename($PROGRAM_NAME)

  # If no arguments, print usage
  if ARGV.empty?
    puts "#{bin_name}: No arguments provided"
    puts "Usage: #{bin_name} FILE"
    exit 1
  end

  filename = ARGV[0]

  # Parse JSON file provided as argument, handle errors
  begin
    file = File.read(filename)
    data = JSON.parse(file)
  rescue Errno::ENOENT => e
    puts "#{bin_name}: #{filename}: No such file"
    exit 1
  rescue => e
    puts "#{bin_name}: #{filename}: Invalid file"
    exit 1
  end

  tournament_name = data["tournament_name"]
  n_participants = data["participants"].length
  n_days = get_days(data["start_date"], data["end_date"])
  n_hours = get_hours(data["start_time"], data["end_time"])

  # Print parsed data
  puts "Generating a schedule for the tournament '#{tournament_name}'"
  puts "  - Participants: #{data["participants"].join(", ")}"
  puts "  - To be played in #{n_days} days"
  puts "  - Among #{n_hours} hours of the day\n\n"

  if !makes_sense?(n_participants, n_days, n_hours)
    puts "The tournament you just planned doesn't even make sense, go to sleep ğŸ¦†"
    exit 0
  end

  thr = Thread.new do
    cnf_filename = translate_to_cnf(n_participants, n_days, n_hours, filename)
  end

  # While wait for the thread to finish, show a spinner
  begin
    while thr.alive? do
      for i in 0..3 do
        print "\rWait while we're explaining your tournament to the computer ğŸ¥¬#{'.' * i}#{' ' * (3 - i)}"
        sleep 0.3
      end
    end
  rescue Interrupt
    puts "\rInterrupted! ğŸ¤¬#{" " * 112}\n\n"
    exit 1
  end
  puts "\rUnderstanding complete! ğŸ’…#{" " * 100}\n\n"

  cnf_filename = translate_to_cnf(n_participants, n_days, n_hours, filename)
  solution_filename = solve_cnf(cnf_filename, "glucose")

  solution = extract_solution(solution_filename, n_participants, n_days, n_hours)
  if solution.empty?
    puts "A schedule for this tournament isn't possible, plan something else ğŸ¦§"
    exit 0
  end

  # Create .ics file from solution
  output_filename = create_ics(
    solution,
    data["tournament_name"],
    data["participants"],
    data["start_date"],
    data["start_time"]
  )

  puts "Done! You can check your calendar at '#{output_filename}', have fun ğŸ“µ"
end

main if __FILE__ == $0
